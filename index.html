<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>PDHhub Certificates</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; max-width: 720px; margin: 40px auto; color: #222; background:#fff; }
    h1 { margin-bottom: 8px; color:#006400; } /* dark green */
    .sub { color:#444; margin-top:0; }
    form { margin: 16px 0 24px; }
    input { width: 100%; padding: 10px; font-size: 16px; margin-bottom: 12px; border:1px solid #006400; border-radius:6px; }
    button { background:#006400; color:#fff; border:none; padding:10px 16px; font-size:16px; border-radius:6px; cursor:pointer; }
    button:hover { background:#008000; }
    .result { border:1px solid #006400; border-radius:8px; padding:16px; margin-top:12px; background:#f9fff9; }
    .cert-list { list-style:none; padding-left:0; }
    .cert-list li { display:flex; justify-content:space-between; align-items:center; border-bottom:1px dashed #ccc; padding:8px 0; }
    .empty { color:#a33; }
    .link { color:#006400; text-decoration:none; }
    .link:hover { text-decoration:underline; }
  </style>
  <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
  <h1>Get My Certificates</h1>
  <p class="sub">Sign in with Google, then enter your email or license number.</p>

  <button onclick="signIn()">Sign in with Google</button>

  <form id="searchForm" style="display:none;">
    <input id="query" type="text" placeholder="e.g. jane.doe@example.com or 80060045UAE" required />
    <button type="submit">Search</button>
  </form>

  <div id="output"></div>

  <script>
    const CLIENT_ID = "727272660788-9elavgrbn9vp5frh3j55ggi8b4tg01l8.apps.googleusercontent.com"; // your OAuth client ID
    const SHEET_ID = "1zFmBLSXnOlvd-iWh9Z7Zu79_XI7p80gu-0oPllh7r7Y"; // your sheet
    const RANGE = "Sheet1!A1:H";

    function signIn() {
      gapi.load("client:auth2", () => {
        gapi.auth2.init({ client_id: CLIENT_ID }).then(() => {
          gapi.auth2.getAuthInstance().signIn().then(user => {
            document.getElementById("searchForm").style.display = "block";
            initClient();
          });
        });
      });
    }

    function initClient() {
      gapi.client.init({
        discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"]
      });
    }

    async function fetchSheet() {
      const response = await gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: SHEET_ID,
        range: RANGE
      });
      return response.result.values || [];
    }

    function escapeHtml(str) {
      return String(str || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;");
    }

    function renderResults(rows, q) {
      const query = q.trim().toLowerCase();
      const headers = rows[0].map(h => h.toLowerCase().trim());
      const emailCol = headers.indexOf("email");
      const licenseCol = headers.indexOf("license_number");
      const courseCol = headers.indexOf("course_name");
      const dateCol = headers.indexOf("completion_date");
      const linkCol = headers.indexOf("drive_link");
      const firstCol = headers.indexOf("first_name");
      const lastCol = headers.indexOf("last_name");

      const matches = rows.slice(1).filter(r => {
        const email = (r[emailCol] || "").toLowerCase().trim();
        const license = (r[licenseCol] || "").toLowerCase().trim();
        return email === query || license === query;
      });

      if (matches.length === 0) {
        output.innerHTML = `<p class="empty">No certificates found for ${escapeHtml(q)}</p>`;
        return;
      }

      const list = matches.map(r => {
        const course = escapeHtml(r[courseCol] || "");
        const date = escapeHtml(r[dateCol] || "");
        const link = r[linkCol] || "#";
        return `<li><span>${course} (${date})</span><a class="link" href="${link}" target="_blank">Download</a></li>`;
      }).join("");

      output.innerHTML = `
        <div class="result">
          <p><strong>${matches[0][firstCol]} ${matches[0][lastCol]}</strong></p>
          <ul class="cert-list">${list}</ul>
        </div>
      `;
    }

    const form = document.getElementById("searchForm");
    const input = document.getElementById("query");
    const output = document.getElementById("output");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      output.textContent = "Searchingâ€¦";
      try {
        const rows = await fetchSheet();
        renderResults(rows, input.value);
      } catch (err) {
        console.error(err);
        output.innerHTML = `<p class="empty">Unable to load data.</p>`;
      }
    });
  </script>
</body>
</html>
